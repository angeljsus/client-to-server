"use strict";function getDatabase(){return openDatabase("JsonQZip","1.0","Almacenamiento de prueba de informaciÃ³n.",1e6)}function cargarTablas(){var e=getDatabase();return new Promise(function(t,n){e.transaction(function(t){t.executeSql("\n\t\t\t\tCREATE TABLE IF NOT EXISTS tabla1 (\n\t\t\t\t\tusuario int(11),\n\t\t\t\t\tproyecto int(11),\n\t\t\t\t\tcol3 int(11),\n\t\t\t\t\tcol4 int(11),\n\t\t\t\t\tcol5 int(11),\n\t\t\t\t\tcol6 int(11),\n\t\t\t\t\tcol7 int(11),\n\t\t\t\t\tcol8 int(11),\n\t\t\t\t\tcol9 int(11),\n\t\t\t\t\tcol10 int(11),\n\t\t\t\t\tcol11 int(11),\n\t\t\t\t\tcol12 int(11),\n\t\t\t\t\tcol13 int(11),\n\t\t\t\t\tcol14 int(11),\n\t\t\t\t\tcol15 int(11),\n\t\t\t\t\tcol16 varchar(300),\n\t\t\t\t\tcol17 varchar(300),\n\t\t\t\t\tcol18 varchar(300),\n\t\t\t\t\tcol19 varchar(300),\n\t\t\t\t\tcol20 varchar(300),\n\t\t\t\t\tcol21 varchar(300),\n\t\t\t\t\tcol22 varchar(300),\n\t\t\t\t\tcol23 varchar(300),\n\t\t\t\t\tcol24 varchar(300),\n\t\t\t\t\tcol25 varchar(300),\n\t\t\t\t\tPRIMARY KEY (usuario, proyecto)\n\t\t\t\t);\n\t\t\t"),t.executeSql("\n\t\t\t\tCREATE TABLE IF NOT EXISTS tabla2 (\n\t\t\t\t\tusuario int(11),\n\t\t\t\t\tproyecto int(11),\n\t\t\t\t\tcol3 int(11),\n\t\t\t\t\tcol4 int(11),\n\t\t\t\t\tcol5 int(11),\n\t\t\t\t\tcol6 int(11),\n\t\t\t\t\tcol7 int(11),\n\t\t\t\t\tcol8 int(11),\n\t\t\t\t\tcol9 int(11),\n\t\t\t\t\tcol10 int(11),\n\t\t\t\t\tcol11 int(11),\n\t\t\t\t\tcol12 int(11),\n\t\t\t\t\tcol13 int(11),\n\t\t\t\t\tcol14 int(11),\n\t\t\t\t\tcol15 int(11),\n\t\t\t\t\tcol16 varchar(300),\n\t\t\t\t\tcol17 varchar(300),\n\t\t\t\t\tcol18 varchar(300),\n\t\t\t\t\tcol19 varchar(300),\n\t\t\t\t\tcol20 varchar(300),\n\t\t\t\t\tcol21 varchar(300),\n\t\t\t\t\tcol22 varchar(300),\n\t\t\t\t\tcol23 varchar(300),\n\t\t\t\t\tcol24 varchar(300),\n\t\t\t\t\tcol25 varchar(300),\n\t\t\t\t\tPRIMARY KEY (usuario, proyecto)\n\t\t\t\t);\n\t\t\t"),t.executeSql("\n\t\t\t\tCREATE TABLE IF NOT EXISTS tabla3 (\n\t\t\t\t\tusuario int(11),\n\t\t\t\t\tproyecto int(11),\n\t\t\t\t\tcol3 int(11),\n\t\t\t\t\tcol4 int(11),\n\t\t\t\t\tcol5 int(11),\n\t\t\t\t\tcol6 int(11),\n\t\t\t\t\tcol7 int(11),\n\t\t\t\t\tcol8 int(11),\n\t\t\t\t\tcol9 int(11),\n\t\t\t\t\tcol10 int(11),\n\t\t\t\t\tcol11 int(11),\n\t\t\t\t\tcol12 int(11),\n\t\t\t\t\tcol13 int(11),\n\t\t\t\t\tcol14 int(11),\n\t\t\t\t\tcol15 int(11),\n\t\t\t\t\tcol16 varchar(300),\n\t\t\t\t\tcol17 varchar(300),\n\t\t\t\t\tcol18 varchar(300),\n\t\t\t\t\tcol19 varchar(300),\n\t\t\t\t\tcol20 varchar(300),\n\t\t\t\t\tcol21 varchar(300),\n\t\t\t\t\tcol22 varchar(300),\n\t\t\t\t\tcol23 varchar(300),\n\t\t\t\t\tcol24 varchar(300),\n\t\t\t\t\tcol25 varchar(300),\n\t\t\t\t\tPRIMARY KEY (usuario, proyecto)\n\t\t\t\t);\n\t\t\t")},function(t){console.error("00-> %s",t.message)},function(){t()})})}var fs=require("fs-extra"),path=require("path"),os=require("os"),archiver=require("archiver"),_require=require(__dirname+"\\js\\querys.min.js"),select=_require.select;function initialize(){console.log("App initialized!"),cargarTablas().then(function(){return archiver.registerFormat("zip-encryptable",require("archiver-zip-encryptable"))}).then(function(){console.log("Zip encriptable esta registrado!"),document.getElementById("button").addEventListener("click",function(){var t={tablas:["tabla1","tabla2","tabla3"],totalRegistros:1e4,passworZip:"zipPass",phpFile:"http://localhost/zipZone/accept.php"};procesarInformacion("1","1",t).then(function(t){console.log(t)})})})}function procesarInformacion(t,n,e){return e.totalRegistros||(e.totalRegistros=88250),generarConsultas(t,n,e).then(function(e){return new Promise(function(n,t){createTmpDir().then(function(t){n({path:t+"\\",array:e})})})}).then(function(t){return crearArchivosDatos(t.array,t.path,e.passworZip)}).then(function(t){return realizarTransferencia(t,e.phpFile)}).then(function(t){return fs.removeSync(t.pathProccess),t.messages}).catch(function(t){console.error(t)})}function generarConsultas(o,a,c){var i,l,s=c.tablas,u=[],h=0,f=0;return new Promise(function(t,n){for(var e=0,r=Promise.resolve();e<s.length;e++)!function(n,e){r=e=e.then(function(){return i=s[n],r=e,select(i,{cols:"count(*) total",where:{variables:"usuario, proyecto",valores:"".concat(o,"__").concat(a)}})}).then(function(t){return l={tableName:s[n],cantRows:t[0].total,vecesLimite:Math.trunc(t[0].total/c.totalRegistros),resto:t[0].total-Math.trunc(t[0].total/c.totalRegistros)*c.totalRegistros},r=e,l}).then(function(t){if(0<t.cantRows){h=t.vecesLimite,t.vecesLimite<1&&(h=1);for(var n=0;n<h;n++)t.vecesLimite<1?u.push({tableName:t.tableName,where:{variables:"usuario, proyecto",valores:"".concat(o,"__").concat(a)},limit:{start:0,end:t.cantRows}}):(f=c.totalRegistros*n,u.push({tableName:t.tableName,where:{variables:"usuario, proyecto",valores:"".concat(o,"__").concat(a)},limit:{start:f,end:c.totalRegistros}}),h-1==n&&0<t.resto&&(f+=c.totalRegistros,u.push({tableName:t.tableName,where:{variables:"usuario, proyecto",valores:"".concat(o,"__").concat(a)},limit:{start:f,end:t.resto}})))}r=e}).then(function(){n==s.length-1&&t(u)})}(e,r);0==s.length&&n('Falta propiedad en el objeto json de parametro obj.tablas:["t1","t2"]')})}function crearArchivosDatos(a,c,i){var l,s,u,h=0,f=0,p="",v="",m="",b="";return new Promise(function(e,t){for(var n=0,o=Promise.resolve();n<a.length;n++)!function(n,r){o=r=r.then(function(){return o=r,select(a[n].tableName,{cols:"*",where:a[n].where,limit:a[n].limit})}).then(function(t){if(p=",\n",v="",l="file_"+n+".json",f=0,s=c+"json"+path.sep+l,fs.ensureFileSync(s),0<t.length){for(h=0,v='{ "'.concat(a[n].tableName,'" : [\n'),fs.appendFileSync(s,v),v="";h==t.length-1&&(p=""),v+="\t\t".concat(JSON.stringify(t[h])).concat(p),1e4!=f&&h!=t.length-1||(fs.appendFileSync(s,v),v="",f=0),f++,++h<t.length;);return v="\n\t]\n}\n",fs.appendFileSync(s,v),v="",o=r,s}}).then(function(e){return o=r,new Promise(function(t,n){m=path.basename(e,".json"),m+=".zip",u=fs.createWriteStream(c+"/"+m,{autoClose:!0}),(b=new archiver("zip-encryptable",{zlib:{level:9},forceLocalTime:!0,password:i})).pipe(u),b.file(e,{name:path.basename(e)}),b.finalize(),b.on("end",function(){t(e)}),b.on("error",function(t){n(t)})})}).then(function(t){n==a.length-1&&(fs.removeSync(path.dirname(t)),e(c))})}(n,o)})}function realizarTransferencia(a,c){var i,l=fs.readdirSync(a),s=[];return new Promise(function(r,t){if(0<l.length)for(var n=0,o=Promise.resolve();n<l.length;n++)!function(n,e){o=e=e.then(function(){return o=e,fs.readFile(a+l[n],{encoding:"base64"})}).then(function(t){return i={data:t,zipName:l[n]},o=e,fetch(c,{method:"POST",body:JSON.stringify(i),headers:{"Content-Type":"application/json"}})}).then(function(t){return o=e,t.text()}).then(function(t){s.push({response:t}),n==l.length-1&&r({pathProccess:a,messages:s})})}(n,o);else t("No se crearon achivos en: ",a)})}function createTmpDir(){var t=os.tmpdir();return new Promise(function(e,r){fs.mkdtemp("".concat(t).concat(path.sep),function(t,n){t?r(t):e(n)})})}document.addEventListener("DOMContentLoaded",initialize);